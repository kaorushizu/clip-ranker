OK。じゃあ **Cursorに投げる“要件定義＋実装指示”**を作る。これコピペしてAIに渡して。
（狙い：まず動くPoC → 速度/精度の検証ができる状態）

⸻

Cursorへの指示文（CLIP Ranker API / コピペ用）

目的：clip.revathis-dev.com で公開する 画像類似ランキングAPI（CLIP） を作る。
既存環境：
	•	VPS: 162.43.20.180
	•	Caddy (container revathis-ai-caddy) が HTTPS を提供
	•	Docker network: revathis-ai-agents_default が存在
	•	clip.revathis-dev.com は今 respond になっている（後で reverse_proxy に戻す）
	•	検索結果は各アイテム画像URL 1枚のみ（titleもある）

ゴール（PoC）

Expoアプリの一覧画面でボタン押下 →
「撮影元画像（base64）」と「候補50件（auction_id + image_url + title）」をAPIに投げる →
類似度スコア順で rank/score を返し、画面で並べ替えできる。

⸻

実装要件

1) サービス構成
	•	新規ディレクトリ：/root/clip-ranker
	•	Dockerで起動する FastAPI サービス（コンテナ名 clip-api）
	•	外部公開ポートは出さない（expose: 8000 のみ）
	•	Caddyが clip.revathis-dev.com → clip-api:8000 に reverse_proxy する

2) モデル（最初は軽量）
	•	OpenCLIP / CLIP系で、まずは ViT-B/32 を採用（CPUでPoC用）
	•	画像前処理：長辺 768 へリサイズ（アスペクト維持）、RGB変換
	•	ベクトル：L2正規化して cosine similarity を計算

3) API仕様

GET /healthz
	•	200 "ok" を返す

POST /rank

request JSON

{
  "query_image_base64": "<base64>",
  "candidates": [
    { "auction_id": "A1", "image_url": "https://...", "title": "..." }
  ],
  "top_k": 50,
  "max_concurrency": 10,
  "image_resize": 768
}

response JSON

{
  "results": [
    { "auction_id": "A2", "score": 0.873, "rank": 1 },
    { "auction_id": "A1", "score": 0.812, "rank": 2 }
  ],
  "failed": [
    { "auction_id": "A9", "reason": "download_failed" }
  ],
  "meta": {
    "model": "openclip_vit_b32",
    "image_resize": 768,
    "candidates": 50,
    "succeeded": 47,
    "failed": 3
  }
}

※タイトルは今回未使用でもOK（将来：画像×テキスト併用に拡張できる形だけ残す）

4) 画像URLのダウンロード
	•	Python側で httpx を使用（timeout 3s、retry 1回）
	•	WebP/PNG/JPEGに対応（PILで読み込み）
	•	失敗した候補は failed[] に入れて続行

5) 並列制御
	•	max_concurrency の数でダウンロード＋前処理を並列化（async/await）
	•	推論（embedding）はバッチ化できるならバッチで（難しければ逐次でもOK、PoC優先）

6) Docker

/root/clip-ranker に以下を作成：
	•	app.py（FastAPI本体）
	•	requirements.txt（例：fastapi, uvicorn, torch, open_clip_torch, pillow, httpx, numpy）
	•	Dockerfile（Python slim + pip install + uvicorn起動）
	•	docker-compose.yml（外部ネットワーク revathis-ai-agents_default に参加）

docker-compose.yml（固定）

services:
  clip-api:
    build: .
    container_name: clip-api
    restart: unless-stopped
    expose:
      - "8000"
    networks:
      - edge

networks:
  edge:
    external: true
    name: revathis-ai-agents_default

7) Caddyfile変更（手順も提示）

/root/revathis-ai-agents/Caddyfile の clip.revathis-dev.com を以下に変更する手順を書く：

clip.revathis-dev.com {
  reverse_proxy clip-api:8000
}

その後：

docker restart revathis-ai-caddy

8) 動作確認コマンド（VPSで）
	•	起動：

cd /root/clip-ranker
docker compose up -d --build
docker logs clip-api --tail=50

	•	内部疎通（Caddyコンテナ→clip-api）：

docker exec -it revathis-ai-caddy wget -qO- http://clip-api:8000/healthz

	•	外部疎通：

curl -s https://clip.revathis-dev.com/healthz

	•	rankテスト（curl例も提示）

⸻

重要：PoC優先

最初は “動くこと” が最優先。
精度チューニング（SigLIP/ViT-L/14、タイトル併用、閾値等）は次フェーズ。

⸻

この指示に従ってファイル一式を作り、docker compose up -d --build が通って healthz が返るところまで実装して。次に /rank のcurlテスト例を添えて。

⸻

これをCursorに投げたら、返ってきた requirements.txt / Dockerfile / app.py を貼ってくれ。俺がレビューして「速度/精度/例外処理」で最短改善案を出す。